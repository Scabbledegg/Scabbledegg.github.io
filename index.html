<script>
  // Zelfde sanitize als Python
  function sanitizeFileName(name) {
    return name
      .replace(/[/:]/g, "-")
      .replace(/[^a-zA-Z0-9\s\-]/g, "")
      .trim()
      .replace(/\s+/g, " ");
  }

  // Format euro
  function euroFmt(n) {
    if (n === null || n === undefined) return "—";
    try {
      return new Intl.NumberFormat(undefined, { style: "currency", currency: "EUR" }).format(n);
    } catch (e) {
      return "€" + n;
    }
  }

  let priceMap = {}; // gevuld met data/prices.json -> .prices

  Papa.parse("Bulk.csv", {
    download: true,
    header: true,
    complete: function(results) {
      const data = results.data;
      const grid = document.getElementById("cardGrid");
      const filterSet = document.getElementById("filterSet");

      // Vul set-filter (zoals voorheen)
      const sets = [...new Set(data.map(c => c["Set name"]))].filter(Boolean).sort();
      sets.forEach(set => {
        const opt = document.createElement("option");
        opt.value = set;
        opt.textContent = set;
        filterSet.appendChild(opt);
      });

      // probeer prijzen te laden (indien aanwezig)
      fetch("data/prices.json", { cache: "no-store" })
        .then(res => {
          if (!res.ok) throw new Error("prices.json niet beschikbaar");
          return res.json();
        })
        .then(json => {
          priceMap = json.prices || {};
        })
        .catch(err => {
          console.warn("Geen prices.json gevonden of load faalde:", err);
          priceMap = {};
        })
        .finally(() => {
          // renderen, of opnieuw op filters
          renderCards();
        });

      function getPriceFor(name, set) {
        const key = `${name}|${set}`.replace(/\|$/, "");
        const info = priceMap[key] || priceMap[name] || null;
        if (!info) return null;
        return info.chosen_price_eur ?? info.price_eur ?? info.price_eur_foil ?? null;
      }

      function renderCards() {
        const searchName = document.getElementById("searchName").value.toLowerCase();
        const selectedSet = filterSet.value;
        const selectedRarity = document.getElementById("filterRarity").value;

        grid.innerHTML = "";

        data.forEach(card => {
          if (!card["Name"]) return;

          const name = card["Name"];
          const set = card["Set name"];
          const rarity = card["Rarity"] || "";
          const qty = card["Quantity"] || "1";

          // Filters
          if (searchName && !name.toLowerCase().includes(searchName)) return;
          if (selectedSet && set !== selectedSet) return;
          if (selectedRarity && rarity.toLowerCase() !== selectedRarity) return;

          const div = document.createElement("div");
          div.className = "card";

          const imgFile = "./card_images/" + sanitizeFileName(name) + ".jpg";

          // prijs ophalen
          const priceVal = getPriceFor(name, set);
          const priceHtml = priceVal != null ? `<p class="price">${euroFmt(priceVal)}</p>` : `<p class="price">—</p>`;

          div.innerHTML = `
            <img src="${imgFile}" alt="${name}" onerror="this.style.opacity='.2'; this.nextElementSibling && (this.nextElementSibling.style.opacity='.6')">
            <h3>${name}</h3>
            <p>${set} - ${rarity}</p>
            <p>Copies: ${qty}</p>
            ${priceHtml}
          `;
          grid.appendChild(div);
        });
      }

      // Filters & search
      document.getElementById("searchName").addEventListener("input", renderCards);
      document.getElementById("filterSet").addEventListener("change", renderCards);
      document.getElementById("filterRarity").addEventListener("change", renderCards);
    }
  });
</script>

<style>
  /* voeg dit toe in <head> of bestaand style-blok */
  .price { font-weight: 700; margin-top: 6px; font-size: 13px; color: #dcdcdc; }
</style>
